name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build release artifacts
        run: |
          # Build API
          dotnet publish src/MarsVista.Api -c Release -o ./publish/api

          # Build Scraper
          dotnet publish src/MarsVista.Scraper -c Release -o ./publish/scraper

      - name: Create release archives
        run: |
          cd publish
          tar -czvf ../mars-vista-api-${{ steps.version.outputs.VERSION }}-linux-x64.tar.gz api/
          tar -czvf ../mars-vista-scraper-${{ steps.version.outputs.VERSION }}-linux-x64.tar.gz scraper/

      - name: Extract changelog for version
        id: changelog
        run: |
          # Extract the changelog section for this version
          VERSION="${{ steps.version.outputs.VERSION }}"

          # Get content between this version header and next version header (or end)
          CHANGELOG=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)

          # If no specific section found, use a default message
          if [[ -z "$CHANGELOG" ]]; then
            CHANGELOG="Release $VERSION"
          fi

          # Write to file to handle multiline
          echo "$CHANGELOG" > release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          files: |
            mars-vista-api-${{ steps.version.outputs.VERSION }}-linux-x64.tar.gz
            mars-vista-scraper-${{ steps.version.outputs.VERSION }}-linux-x64.tar.gz
            openapi.json
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}

  docker-publish:
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/api:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository }}/api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Scraper image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.scraper
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/scraper:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository }}/scraper:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
